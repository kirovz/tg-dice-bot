require('dotenv').config();
const TelegramBot = require("node-telegram-bot-api");
const token = process.env.TELEGRAM_TOKEN; // –¢–æ–∫–µ–Ω —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ .env
const bot = new TelegramBot(token, { polling: true });

// /start
bot.onText(/\/start/, (msg) => {
  bot.sendMessage(msg.chat.id, "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–∫—É–±–∏–∫ üé≤ –ù–∞–ø–∏—à–∏ /d20 –∏–ª–∏ /roll 3d6.");
});

// /d20 (–æ–¥–∏–Ω –±—Ä–æ—Å–æ–∫ 20-–≥—Ä–∞–Ω–Ω–æ–≥–æ –∫—É–±–∞)
bot.onText(/\/d20/, (msg) => {
  const roll = Math.floor(Math.random() * 20) + 1;
  bot.sendMessage(msg.chat.id, `üé≤ –í—ã–ø–∞–ª–æ: ${roll}`);
});

// /nd20 (–æ–¥–∏–Ω –±—Ä–æ—Å–æ–∫ 20-–≥—Ä–∞–Ω–Ω–æ–≥–æ –∫—É–±–∞ –≤—ã–ø–∞–¥–∞–µ—Ç –í–°–ï–ì–î–ê 20)
bot.onText(/\/nd20/, (msg) => {
  const roll = 20;
  bot.sendMessage(msg.chat.id, `üé≤ –í—ã–ø–∞–ª–æ: ${roll}`);
});

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: /roll 3d20
bot.onText(/\/roll (.+)/, (msg, match) => {
  const chatId = msg.chat.id;
  const input = match[1].toLowerCase().trim(); // –Ω–∞–ø—Ä–∏–º–µ—Ä "3d20"

  const regex = /^(\d*)d(\d+)$/;
  const parsed = input.match(regex);

  if (!parsed) {
    bot.sendMessage(chatId, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π: /roll 3d20");
    return;
  }

  const count = parseInt(parsed[1] || "1", 10);
  const sides = parseInt(parsed[2], 10);

  if (count > 100) {
    bot.sendMessage(chatId, "‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫—É–±–æ–≤ (–º–∞–∫—Å 100).");
    return;
  }

  const rolls = Array.from({ length: count }, () => Math.floor(Math.random() * sides) + 1);
  const total = rolls.reduce((a, b) => a + b, 0);

  bot.sendMessage(chatId, `üé≤ ${count}d${sides} ‚Üí [${rolls.join(", ")}] = ${total}`);
});

// –ú–∞–≥–∏—á–µ—Å–∫–∏–π —à–∞—Ä
const answers = [
  "–î–∞",
  "–ù–µ—Ç",
  "–í–æ–∑–º–æ–∂–Ω–æ",
  "–ú–∞–∂–ª–∏–≤–æ",
  "–ù–∞–≤–µ—Ä–Ω–æ–µ –Ω–µ—Ç",
  "–ë–µ–∑ —Å–æ–º–Ω–µ–Ω–∏–π",
  "–û—á–µ–Ω—å —Å–æ–º–Ω–µ–≤–∞—é—Å—å",
  "–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ",
  "–í–µ—Å—å–º–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ",
  "–ó–ê –¢–ê–ö–û–ï –ù–ï –ë–õ–ê–ì–û–î–ê–†–Ø–¢!",
  "–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ –¥–∞",
];

// —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
bot.onText(/^\/ask\b/, (msg) => {
  const chatId = msg.chat.id;

  bot.sendMessage(chatId, "üîÆ –®–∞—Ä –¥—É–º–∞–µ—Ç...")
    .then(() => {
      setTimeout(() => {
        const index = Math.floor(Math.random() * answers.length);
        bot.sendMessage(chatId, `–û—Ç–≤–µ—Ç: ${answers[index]}`);
      }, 2000);
    });
});